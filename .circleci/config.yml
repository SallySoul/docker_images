version: 2.1

executors:
  compiler:
    docker:
      - image: docker:17.06.0-ce-git
    working_directory: ~/repo

jobs:
  cmake:
    executor: compiler
    steps:
      - checkout
      - setup_remote_docker:
          reusable: true
          exclusive: true
      - run:
          name: Install bash
          command: apk add --no-cache bash
      - run:
          name: Build + deploy image
          command: ./build-and-deploy-image cmake ${DOCKER_USER} ${DOCKER_PASSWORD} ${CIRCLE_BRANCH} ${CIRCLE_SHA1}
          no_output_timeout: "30m"
      - persist_to_workspace:
          root: /root/repo
          paths:
            - branch_cache.txt

  intel_mkl:
    executor: compiler
    steps:
      - checkout
      - setup_remote_docker:
          reusable: true
          exclusive: true
      - run:
          name: Install bash
          command: apk add --no-cache bash
      - attach_workspace:
          at: /root/repo
      - run:
          name: Build + deploy image
          command: ./build-and-deploy-image intel_mkl ${DOCKER_USER} ${DOCKER_PASSWORD} ${CIRCLE_BRANCH} ${CIRCLE_SHA1}
          no_output_timeout: "30m"
      - persist_to_workspace:
          root: /root/repo
          paths:
            - branch_cache.txt

  vtk:
    executor: compiler
    steps:
      - checkout
      - setup_remote_docker:
          reusable: true
          exclusive: true
      - run:
          name: Install bash
          command: apk add --no-cache bash
      - attach_workspace:
          at: /root/repo
      - run:
          name: Build + deploy image
          command: ./build-and-deploy-image vtk ${DOCKER_USER} ${DOCKER_PASSWORD} ${CIRCLE_BRANCH} ${CIRCLE_SHA1}
          no_output_timeout: "30m"
      - persist_to_workspace:
          root: /root/repo
          paths:
            - branch_cache.txt

  mkl_vtk:
    executor: compiler
    steps:
      - checkout
      - setup_remote_docker:
          reusable: true
          exclusive: true
      - run:
          name: Install bash
          command: apk add --no-cache bash
      - attach_workspace:
          at: /root/repo
      - run:
          name: Build + deploy image
          command: ./build-and-deploy-image mkl_vtk ${DOCKER_USER} ${DOCKER_PASSWORD} ${CIRCLE_BRANCH} ${CIRCLE_SHA1}
          no_output_timeout: "30m"
      - persist_to_workspace:
          root: /root/repo
          paths:
            - branch_cache.txt

  petsc:
    executor: compiler
    steps:
      - checkout
      - setup_remote_docker:
          reusable: true
          exclusive: true
      - attach_workspace:
          at: /root/repo
      - run:
          name: Install bash
          command: apk add --no-cache bash
      - run:
          name: Build + deploy image
          command: ./build-and-deploy-image petsc ${DOCKER_USER} ${DOCKER_PASSWORD} ${CIRCLE_BRANCH} ${CIRCLE_SHA1}
          no_output_timeout: "30m"
      - persist_to_workspace:
          root: /root/repo
          paths:
            - branch_cache.txt

  slepc:
    executor: compiler
    steps:
      - checkout
      - setup_remote_docker:
          reusable: true
          exclusive: true
      - attach_workspace:
          at: /root/repo
      - run:
          name: Install bash
          command: apk add --no-cache bash
      - run:
          name: Build + deploy image
          command: ./build-and-deploy-image slepc ${DOCKER_USER} ${DOCKER_PASSWORD} ${CIRCLE_BRANCH} ${CIRCLE_SHA1}
          no_output_timeout: "30m"
      - persist_to_workspace:
          root: /root/repo
          paths:
            - branch_cache.txt

  libmesh:
    executor: compiler
    steps:
      - checkout
      - setup_remote_docker:
          reusable: true
          exclusive: true
      - run:
          name: Install bash
          command: apk add --no-cache bash
      - attach_workspace:
          at: /root/repo
      - run:
          name: Build + deploy image
          command: ./build-and-deploy-image libmesh ${DOCKER_USER} ${DOCKER_PASSWORD} ${CIRCLE_BRANCH} ${CIRCLE_SHA1}
          no_output_timeout: "30m"
      - persist_to_workspace:
          root: /root/repo
          paths:
            - branch_cache.txt

  mfem:
    executor: compiler
    steps:
      - checkout
      - setup_remote_docker:
          reusable: true
          exclusive: true
      - run:
          name: Install bash
          command: apk add --no-cache bash
      - attach_workspace:
          at: /root/repo
      - run:
          name: Build + deploy image
          command: ./build-and-deploy-image mfem ${DOCKER_USER} ${DOCKER_PASSWORD} ${CIRCLE_BRANCH} ${CIRCLE_SHA1}
          no_output_timeout: "30m"
      - persist_to_workspace:
          root: /root/repo
          paths:
            - branch_cache.txt

  trilinos:
    executor: compiler
    steps:
      - checkout
      - setup_remote_docker:
          reusable: true
          exclusive: true
      - run:
          name: Install bash
          command: apk add --no-cache bash
      - attach_workspace:
          at: /root/repo
      - run:
          name: Build + deploy image
          command: ./build-and-deploy-image trilinos ${DOCKER_USER} ${DOCKER_PASSWORD} ${CIRCLE_BRANCH} ${CIRCLE_SHA1}
          no_output_timeout: "30m"
      - persist_to_workspace:
          root: /root/repo
          paths:
            - branch_cache.txt

  dealii:
    executor: compiler
    steps:
      - checkout
      - setup_remote_docker:
          reusable: true
          exclusive: true
      - run:
          name: Install bash
          command: apk add --no-cache bash
      - attach_workspace:
          at: /root/repo
      - run:
          name: Build + deploy image
          command: ./build-and-deploy-image dealii ${DOCKER_USER} ${DOCKER_PASSWORD} ${CIRCLE_BRANCH} ${CIRCLE_SHA1}
          no_output_timeout: "30m"
      - persist_to_workspace:
          root: /root/repo
          paths:
            - branch_cache.txt

workflows:
  version: 2
  build-images:
    jobs:
      - cmake
      - vtk:
          requires:
            - cmake
      - intel_mkl:
          requires:
            - cmake
      - mkl_vtk:
          requires:
            - vtk
      - petsc:
          requires:
            - vtk
      - slepc:
          requires:
            - petsc
      - libmesh:
          requires:
            - slepc
      - mfem:
          requires:
            - slepc
      - trilinos:
          requires:
            - slepc
      - dealii:
          requires:
            - trilinos
